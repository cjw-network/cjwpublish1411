#!/bin/bash
# Script used to prepare for eZ Publish/Platfrom archives
#
# Pre-requirement for LTS (EE) archives (not affecting ezpublish-community):
#     auth.json needs to be placed in either eZ Publish directory or COMPOSER_HOME.
#     If auth.json is placed in COMPOSER_HOME, it needs to be for same user as the one executing script.


# Install all composer deps non-interactivly (yml parameters will be set to default values)
composer install -n --prefer-dist --no-dev

# Replace install instructions for archive instructions
mv -f INSTALL_ARCHIVE.md INSTALL.md

# Rename .gitignore to make it optional as it is optimized for kernel development and not project development
mv .gitignore .gitignore.dist

# Archive: Remove cache (wrong paths), logs (generated by composer call above) & zeta tests (too big)
rm -Rf ezpublish/cache/*/* ezpublish/logs/* vendor/zetacomponents/*/tests

# Archive: Remove git folders (also for kernel and legacy as composer sometimes clones instead of downloading)
rm -Rf .git ezpublish_legacy/.git vendor/ezsystems/ezpublish-kernel/.git


echo << EOF
Ready to archive the result

Assuming current folder is build/ezpublish5 this can be accomplished in the following way:
    cd ../..
    tar czf dist/ezpublish5-\$version-ee-gpl-full.tar.gz --directory=build ezpublish5
EOF
